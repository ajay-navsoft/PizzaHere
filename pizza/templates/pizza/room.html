{% load staticfiles %}
<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" type="text/css" href="{% static 'pizza/style.css' %}">
        <meta http-equiv="content-type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
            integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css"
            rel="stylesheet">

        <title>Chat Room</title>
    </head>

    <body>

        <div class="container py-5 px-4">
            <h3 class=" text-center">Chat Help</h3>
            <!-- <div class="row rounded-lg overflow-hidden shadow"> -->
                <!-- Users box-->
                <!-- <div class="col-5 px-0"> -->
                    <div class="bg-white" id="chatContainer">

                        <div class="bg-gray px-4 py-2 bg-light">
                            <p class="h5 mb-0 py-1">Pizzociety</p>
                        </div>

                        <div id="messageScreen"> </div>

                        <form onSubmit="return false;">
                            <div class="form-group">
                                <!-- <textarea disabled id="chat-log" class="form-control" cols="100" rows="20" ></textarea><br/> -->
                                <input id="chat-message-input" placeholder="Type your message here."
                                    class="form-control" type="text" size="100" /><br />
                                <input id="chat-message-submit" class="btn btn-primary" type="button" value="Send"
                                    disabled="disabled" />
                            </div>
                        </form>
                    </div>
                <!-- </div> -->
            <!-- </div> -->





        </div>

    </body>

<!-- <div class="col-7 px-0 hide hide" id="botMessage">
    <div class="px-4 py-5 chat-box bg-white">
        <div class="media w-50 mb-3"><img
                src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg"
                alt="user" width="50" class="rounded-circle">
            <div class="media-body ml-3">
                <div class="bg-light rounded py-2 px-3 mb-2">
                    <p class="text-small mb-0 text-muted"></p>
                </div>
                <p class="small text-muted">Bot</p>
            </div>
        </div>
    </div>
</div> -->



    <script>
        var roomName = {{room_name_json}};

        var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/pizza/' + roomName + '/');

        chatSocket.onopen = function (e) {
            var data = JSON.parse(e.data);
            var botMessage = data['bot_message'];
            document.querySelector('#chat-log').value += (botMessage + "    (bot)" + '\n')
        }

        function updateScroll() {
            var element = $('#messageScreen');
            element[0].scrollTop = element[0].scrollHeight;
        }

        chatSocket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            var botMessage = data['bot_message'];
            var userMessage = data['user_message'];

            if (userMessage) {
                //document.querySelector('#chat-log').value += (userMessage + "    (you)" + '\n');

                $('#messageScreen').append(
                    '<div class="media w-50 ml-auto mb-3">'+
                        '<div class="media-body">'+
                            '<div class="bg-primary rounded py-2 px-3 mb-2">'+
                                '<p class="text-small mb-0 text-white">' + userMessage + '</p>'+
                            '</div>'+
                            '<p class="small text-muted">You</p>'+
                        '</div>'+
                    '</div>'
                );
                updateScroll();

            }

            setTimeout(function() {
                //document.querySelector('#chat-log').value += (botMessage + "    (bot)" + '\n');
                $('#messageScreen').append(
                    '<div class="col-7 px-0">'+
                        //'<div class="px-4 py-5 chat-box bg-white">'+
                            '<div class="media w-50 mb-3">'+
                                '<img src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg" alt="user" width="50" class="rounded-circle">'+
                                '<div class="media-body ml-3">'+
                                    '<div class="bg-light rounded py-2 px-3 mb-2">'+
                                        '<p class="text-small mb-0 text-muted"> '+ botMessage+' </p>'+
                                    '</div>'+
                                    '<p class="small text-muted">Bot</p>'+
                                '</div>'+
                            '</div>'+
                        //'</div>'+
                    '</div>'
                );
                updateScroll();


            }, 1000);
        };

        chatSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function (e) {
            var messageInputDom = document.querySelector('#chat-message-input');

            var message = messageInputDom.value;
            if (message == "") {
                document.querySelector('#chat-message-submit').setAttribute('disabled', '');
            } else {
                document.querySelector('#chat-message-submit').removeAttribute('disabled');
            }
            if (e.keyCode === 13) { // enter, return
                e.preventDefault();
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function (e) {
            e.preventDefault();
            var messageInputDom = document.querySelector('#chat-message-input');

            var message = messageInputDom.value;
            console.log(message);

            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
            document.querySelector('#chat-message-submit').setAttribute('disabled', 'disabled');
        };
    </script>

</html>